<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="icon" type="image/x-icon" href="/web/favicon.ico">
  <link rel="apple-touch-icon" href="/web/apple-touch-icon.png">
  <link rel="manifest" href="/web/manifest.json">
  <meta name="theme-color" content="#3b82f6">
  <title>渠道管理 - Claude Code & Codex Proxy</title>
  <link rel="stylesheet" href="/web/assets/css/theme.css">
  <link rel="stylesheet" href="/web/assets/css/styles.css">
  <script src="/web/assets/js/theme.js"></script>
  <link href="/web/assets/css/inter.css" rel="stylesheet">
  <link rel="stylesheet" href="/web/assets/css/channels.css">
</head>
<body class="dashboard-theme">
  <div class="app-container">
    <main class="main-content">
      <div class="content-area">
        <header class="mb-2">
        </header>
        <header class="mb-4">
          <div class="glass-card animate-slide-up" style="padding: var(--space-6);">
            <div style="display: flex; align-items: center; justify-content: space-between; gap: 16px; flex-wrap: wrap;">
              <p class="page-subtitle" style="margin: 0;">配置API渠道、优先级和模型支持（<b>优先请求高优先级渠道，相同优先级则轮询调用</b>）</p>
              <div style="display: flex; align-items: center; gap: 12px; flex-wrap: wrap;">
                <button id="exportCsvBtn" type="button" class="btn btn-secondary" style="padding: 8px 16px; font-size: 14px;" title="导出渠道列表为CSV">
                  导出 CSV
                </button>
                <button id="importCsvBtn" type="button" class="btn btn-secondary" style="padding: 8px 16px; font-size: 14px;" title="从CSV导入渠道">
                  导入 CSV
                </button>
                <button onclick="showAddModal()" type="button" class="btn btn-primary" style="padding: 8px 16px; font-size: 14px;" title="添加新渠道">
                  + 添加渠道
                </button>
                <input type="file" id="importCsvInput" accept=".csv" style="display: none;" />
              </div>
            </div>
          </div>
        </header>

        <!-- Filter Bar -->
        <div class="filter-bar">
          <div class="filter-controls">
            <!-- 渠道类型筛选 -->
            <div class="filter-group">
              <label class="filter-label">渠道类型</label>
              <select id="channelTypeFilter" class="filter-select" style="min-width: 120px;">
                <!-- 动态加载渠道类型选项 -->
              </select>
            </div>

            <div class="">
              <label class="filter-label">渠道ID</label>
              <input type="text" id="idFilter" class="filter-input" placeholder="输入ID..." style="max-width: 100px;">
            </div>

            <div class="filter-group">
              <label class="filter-label">状态</label>
              <select id="statusFilter" class="filter-select" style="min-width: 100px;">
                <option value="all">所有状态</option>
                <option value="enabled">已启用</option>
                <option value="disabled">已禁用</option>
                <option value="cooldown">冷却中</option>
              </select>
            </div>

            <div class="filter-group">
              <label class="filter-label">模型</label>
              <select id="modelFilter" class="filter-select" style="min-width: 100px;">
                <option value="all">所有模型</option>
              </select>
            </div>
             <div class="filter-group">
              <label class="filter-label">搜索渠道</label>
              <div style="position: relative; flex: 1; min-width: 140px;">
                <input type="text" id="searchInput" class="filter-input" placeholder="输入渠道名称..." style="padding-right: 36px;">
                <button id="clearSearchBtn" type="button" style="position: absolute; right: 8px; top: 50%; transform: translateY(-50%); background: none; border: none; color: var(--neutral-500); cursor: pointer; font-size: 14px; padding: 2px; opacity: 0; transition: opacity 0.2s; border-radius: 3px;" title="清空搜索" onmouseover="this.style.background='var(--neutral-100)'" onmouseout="this.style.background='none'">
                  ✕
                </button>
              </div>
            </div>
            <!-- 自动测速倒计时组件 -->
            <div class="filter-timer" id="autoTestTimer" title="下次自动测速倒计时" style="display: none;">
              <span class="timer-icon">
                <svg width="12" height="12" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg">
                  <path d="M9.5 1.5L3 9H8.5L6.5 14.5L13 7H7.5L9.5 1.5Z" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
              </span>
              <span class="timer-text">--:--</span>
            </div>
            <div class="filter-info" id="filterInfo"><span id="filteredCount">0</span> / <span id="totalCount">0</span> 个渠道
            </div>
          </div>
        </div>

        <section>
          <div id="channels-container" class="grid grid-cols-1 gap-6"></div>
        </section>
      </div>
    </main>
  </div>

  <!-- 添加/编辑渠道模态框 -->
  <div id="channelModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2 class="modal-title" id="modalTitle">添加渠道</h2>
        <button class="close-btn" onclick="closeModal()">&times;</button>
      </div>
      <form id="channelForm" onsubmit="saveChannel(event)">
        <div class="form-group">
          <!-- 渠道名称、类型和策略全部在一行 -->
          <div style="display: flex; gap: 12px; align-items: center; justify-content: space-between;">
            <div style="display: flex; align-items: center; gap: 8px; flex: 0 0 auto;">
              <label class="form-label" style="margin: 0; white-space: nowrap;">渠道名称 *</label>
              <input type="text" id="channelName" class="form-input" required maxlength="20" style="width: 200px;" placeholder="最多20字符">
            </div>

            <div style="display: flex; align-items: center; gap: 20px;">
              <div style="display: flex; align-items: center; gap: 8px;">
                <label style="margin: 0; font-size: 13px; white-space: nowrap; color: var(--neutral-700);">渠道类型 *</label>
                <div style="display: flex; gap: 12px;" id="channelTypeRadios">
                  <!-- 动态加载渠道类型 -->
                </div>
              </div>

              <div style="display: flex; align-items: center; gap: 8px;">
                <label style="margin: 0; font-size: 13px; white-space: nowrap; color: var(--neutral-700);">Key策略</label>
                <div style="display: flex; gap: 12px;" id="keyStrategyRadios">
                  <label style="display: flex; align-items: center; gap: 4px; cursor: pointer; font-size: 13px;">
                    <input type="radio" name="keyStrategy" value="sequential" checked>
                    <span>顺序</span>
                  </label>
                  <label style="display: flex; align-items: center; gap: 4px; cursor: pointer; font-size: 13px;">
                    <input type="radio" name="keyStrategy" value="round_robin">
                    <span>轮询</span>
                  </label>
                </div>
              </div>
            </div>
          </div>

          <!-- 渠道预设选项（所有渠道类型通用，独立一行） -->
          <div id="channelPresetContainer" style="display: none; margin-top: 12px; padding-left: 80px;">
            <div style="display: flex; align-items: center; gap: 8px;">
              <label style="margin: 0; font-size: 13px; white-space: nowrap; color: var(--neutral-700);">预设</label>
              <div id="channelPresetRadios" style="display: flex; gap: 16px;">
                <label style="display: flex; align-items: center; gap: 4px; cursor: pointer; font-size: 13px;">
                  <input type="radio" name="channelPreset" value="custom" checked onchange="handlePresetChange('custom')">
                  <span>自定义</span>
                </label>
                <label style="display: flex; align-items: center; gap: 4px; cursor: pointer; font-size: 13px;">
                  <input type="radio" name="channelPreset" value="official" onchange="handlePresetChange('official')">
                  <span id="officialPresetLabel">官方</span>
                </label>
                <label id="antigravityPresetLabel" style="display: none; align-items: center; gap: 4px; cursor: pointer; font-size: 13px;">
                  <input type="radio" name="channelPreset" value="antigravity" onchange="handlePresetChange('antigravity')">
                  <span>Antigravity</span>
                  <span style="color: var(--neutral-500); font-size: 11px;">（Google 反代）</span>
                </label>
              </div>
            </div>
          </div>

        </div>

        <div class="form-group">
          <!-- OpenAI 兼容模式开关（Anthropic/Gemini自定义/Codex自定义 显示） -->
          <div id="openaiCompatContainer" style="display: none; margin-bottom: 12px;">
            <div style="display: flex; align-items: center; gap: 8px;">
              <label class="form-label" style="margin: 0; white-space: nowrap;">兼容模式</label>
              <label style="display: flex; align-items: center; gap: 6px; cursor: pointer; font-size: 13px;">
                <input type="checkbox" id="openaiCompatCheckbox" onchange="handleOpenAICompatChange(this.checked)">
                <span>OpenAI 格式</span>
                <span style="color: var(--neutral-500); font-size: 12px;">（使用 /v1/chat/completions 路径）</span>
              </label>
            </div>
          </div>

          <!-- API URL 标签行 -->
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
            <label class="form-label" style="margin: 0;">
              API URL * <span class="models-hint" style="margin-left: 8px; margin-top: 0;">共 <span id="inlineEndpointCount">1</span> 个端点</span>
            </label>
            <div style="display: flex; gap: 6px;">
              <button type="button" class="btn btn-secondary btn-sm" onclick="addInlineEndpoint()" style="padding: 5px 10px; font-size: 12px;">
                + 添加端点
              </button>
              <button type="button" id="manageEndpointsBtn" class="btn btn-secondary btn-sm" onclick="openEndpointModalFromEdit()" style="padding: 5px 10px; font-size: 12px; display: none; white-space: nowrap;" title="测速与高级管理">
                ⚡ 测速
              </button>
            </div>
          </div>

          <!-- 隐藏的input用于表单验证 -->
          <input type="hidden" id="channelUrl" required>

          <!-- 端点表格容器 -->
          <div id="inlineEndpointContainer" style="max-height: 150px; overflow-y: auto; border: 1px solid var(--neutral-200); border-radius: 8px; background: var(--card-bg);">
            <table style="width: 100%; border-collapse: collapse;">
              <tbody id="inlineEndpointTableBody">
                <!-- 端点行将动态插入 -->
              </tbody>
            </table>
          </div>
        </div>

        <div class="form-group">
          <!-- 隐藏的input用于表单验证和提交 -->
          <input type="hidden" id="channelApiKey" required>

          <!-- API Key Card -->
          <div class="api-key-card">
            <!-- Card Header -->
            <div class="api-key-header">
              <div class="api-key-header-left">
                <label class="form-label" style="margin: 0;">
                  API Key * <span class="models-hint" style="margin-left: 8px;">共 <span id="inlineKeyCount">0</span> 个Key <span id="virtualScrollHint" style="display: none; color: var(--primary-600); font-weight: 600;">· 虚拟滚动已启用</span></span>
                </label>
              </div>

              <div class="api-key-header-right">
                <!-- Codex Auth Switch (仅 Codex 渠道显示) -->
                <div id="codexAuthSwitch">
                  <label class="auth-toggle-btn active" id="codexAuthToggleOAuth" onclick="toggleCodexAuthMode('oauth')">
                    <input type="radio" name="codexAuthType" value="oauth" checked style="display:none;"> OAuth
                  </label>
                  <label class="auth-toggle-btn" id="codexAuthToggleApiKey" onclick="toggleCodexAuthMode('apikey')">
                    <input type="radio" name="codexAuthType" value="apikey" style="display:none;"> API Key
                  </label>
                </div>

                <button type="button" class="btn btn-secondary btn-sm" onclick="openInlineKeyImport()" style="padding: 5px 10px; font-size: 12px; display: inline-flex; align-items: center; gap: 4px;">
                  <svg width="12" height="12" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M8 3.5V12M8 12L5 9M8 12L11 9" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                    <path d="M2 13.5H14" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/>
                  </svg>
                  <span>导入</span>
                </button>
                <button type="button" id="toggleInlineKeyBtn" onclick="toggleInlineKeyVisibility()" style="width: 26px; height: 26px; border-radius: 6px; border: 1px solid var(--neutral-300); background: var(--input-focus-bg); color: var(--neutral-500); cursor: pointer; padding: 0; display: inline-flex; align-items: center; justify-content: center; transition: all 0.2s;" title="显示/隐藏API Key" onmouseover="this.style.background='var(--neutral-50)'; this.style.borderColor='var(--neutral-400)';" onmouseout="this.style.background='var(--input-focus-bg)'; this.style.borderColor='var(--neutral-300)';">
                  <svg id="inlineEyeIcon" width="13" height="13" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M1.5 8C1.5 8 3.5 3.5 8 3.5C12.5 3.5 14.5 8 14.5 8C14.5 8 12.5 12.5 8 12.5C3.5 12.5 1.5 8 1.5 8Z" stroke="currentColor" stroke-width="1.2" stroke-linecap="round" stroke-linejoin="round"/>
                    <circle cx="8" cy="8" r="2" stroke="currentColor" stroke-width="1.2" stroke-linecap="round" stroke-linejoin="round"/>
                  </svg>
                  <svg id="inlineEyeOffIcon" width="13" height="13" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" style="display: none;">
                    <path d="M2 2L14 14M6.5 6.5C6.96785 6.03214 7.60786 5.75 8.3 5.75C9.73071 5.75 10.9 6.91929 10.9 8.35C10.9 9.04214 10.6179 9.68215 10.15 10.15M4.5 4.5C2.73 5.67 1.5 8 1.5 8C1.5 8 3.5 12.5 8 12.5C9.35 12.5 10.58 11.97 11.55 11.5M12.85 11.85C13.97 10.73 14.5 8 14.5 8C14.5 8 12.5 3.5 8 3.5C7.23 3.5 6.5 3.73 5.85 4.05" stroke="currentColor" stroke-width="1.2" stroke-linecap="round" stroke-linejoin="round"/>
                  </svg>
                </button>
              </div>
            </div>

            <!-- Card Body -->
            <div class="api-key-body">
              <!-- Standard Key Table Container -->
              <div id="standardKeyContainer" style="max-height: 250px; overflow-y: auto;">
                <table style="width: 100%; border-collapse: collapse;">
                  <thead style="position: sticky; top: 0; z-index: 1; background: var(--neutral-100);">
                    <tr style="border-bottom: 2px solid var(--neutral-300);">
                      <th style="padding: 6px 10px; text-align: left; font-weight: 600; font-size: 13px; width: 70px;">
                        <div style="display: flex; align-items: center; gap: 6px;">
                          <input type="checkbox" id="selectAllKeys" onchange="toggleSelectAllKeys(this.checked)" style="width: 16px; height: 16px; cursor: pointer; accent-color: var(--primary-500);" title="全选/取消全选">
                          <span>#</span>
                        </div>
                      </th>
                      <th style="padding: 6px 10px; text-align: left; font-weight: 600; font-size: 13px;">API Key</th>
                      <th style="padding: 6px 10px; text-align: left; font-weight: 600; font-size: 13px; width: 200px;">
                        <select id="keyStatusFilter" onchange="filterKeysByStatus(this.value)" style="width: 100%; padding: 4px 8px; border: 1px solid var(--neutral-300); border-radius: 6px; font-size: 13px; font-weight: 600; cursor: pointer; background: var(--input-bg);">
                          <option value="all">全部</option>
                          <option value="normal">正常</option>
                          <option value="cooldown">冷却中</option>
                        </select>
                      </th>
                      <th style="padding: 6px 10px; text-align: center; font-weight: 600; font-size: 13px; width: 120px;">
                        <button type="button" id="batchDeleteKeysBtn" onclick="batchDeleteSelectedKeys()" disabled title="批量删除选中的Keys" style="padding: 4px 12px; border-radius: 6px; border: 1px solid var(--neutral-300); background: var(--input-bg); color: var(--neutral-500); cursor: not-allowed; font-size: 12px; font-weight: 500; transition: all 0.2s;">
                          删除选中
                        </button>
                      </th>
                    </tr>
                  </thead>
                  <tbody id="inlineKeyTableBody">
                    <!-- Key行动态渲染 -->
                  </tbody>
                </table>
              </div>

              <!-- Codex OAuth Section (仅 Codex 渠道显示) -->
              <div id="codexOAuthSection" style="display: none;">

            <!-- OAuth 容器 -->
            <div id="codexOAuthContainer">
              <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                <div id="codexTokenStatus" style="display: flex; align-items: center; gap: 8px;">
                  <span id="codexTokenStatusBadge" class="status-badge" style="padding: 4px 10px; border-radius: 12px; font-size: 12px; font-weight: 600; background: var(--neutral-200); color: var(--neutral-600);">未授权</span>
                </div>
              </div>

              <div id="codexTokenInfo" style="display: none; margin-bottom: 12px; padding: 10px; background: var(--card-bg); border-radius: 6px; font-size: 13px;">
                <div style="display: flex; gap: 16px; flex-wrap: wrap;">
                  <div><span style="color: var(--neutral-500);">Account ID:</span> <code id="codexAccountId" style="background: var(--neutral-100); padding: 2px 6px; border-radius: 4px;">-</code></div>
                  <div><span style="color: var(--neutral-500);">过期时间:</span> <span id="codexExpiresAt" style="font-weight: 500;">-</span></div>
                </div>
              </div>

              <div style="display: flex; gap: 8px;">
                <button type="button" id="startCodexOAuthBtn" class="btn btn-primary btn-sm" onclick="startCodexOAuth()" style="padding: 8px 16px;">
                  🚀 开始 OAuth 授权
                </button>
                <button type="button" id="refreshCodexTokenBtn" class="btn btn-secondary btn-sm" onclick="refreshCodexToken()" style="padding: 8px 16px; display: none;">
                  🔄 刷新 Token
                </button>
                <button type="button" id="clearCodexTokenBtn" class="btn btn-secondary btn-sm" onclick="clearCodexToken()" style="padding: 8px 16px; display: none;">
                  🗑️ 清除授权
                </button>
              </div>

              <div style="margin-top: 12px; font-size: 12px; color: var(--neutral-500);">
                <p style="margin: 0;">点击授权后将跳转到 OpenAI 登录页面，完成后请复制 URL 中的授权码并粘贴到下方。</p>
              </div>

              <!-- 手动输入授权码 -->
              <div id="codexManualCodeSection" style="margin-top: 12px;">
                <div style="font-size: 12px; color: var(--neutral-500); margin-bottom: 8px;">
                  授权码（URL 中 <code style="background: var(--neutral-100); padding: 1px 4px; border-radius: 3px;">code=</code> 后的值）
                </div>
                <div style="display: flex; gap: 8px;">
                  <input type="text" id="codexManualCodeInput" class="form-input" placeholder="粘贴 code=... 后的值" style="flex: 1; font-size: 12px;">
                  <button type="button" class="btn btn-secondary btn-sm" onclick="submitManualCodexCode()" style="padding: 6px 12px; font-size: 12px;">
                    提交
                  </button>
                </div>
              </div>
            </div>
          </div>

              <!-- Gemini OAuth Section (仅 Gemini 官方预设显示) -->
              <div id="geminiOAuthSection" style="display: none;">
                <!-- 隐藏字段存储 OAuth Token JSON -->
                <input type="hidden" id="geminiApiKey">

                <!-- OAuth 容器 -->
                <div id="geminiOAuthContainer">
                  <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                    <div id="geminiTokenStatus" style="display: flex; align-items: center; gap: 8px;">
                      <span id="geminiTokenStatusBadge" class="status-badge" style="padding: 4px 10px; border-radius: 12px; font-size: 12px; font-weight: 600; background: var(--neutral-200); color: var(--neutral-600);">未授权</span>
                    </div>
                  </div>

                  <div id="geminiTokenInfo" style="display: none; margin-bottom: 12px; padding: 10px; background: var(--card-bg); border-radius: 6px; font-size: 13px;">
                    <div style="display: flex; gap: 16px; flex-wrap: wrap;">
                      <div><span style="color: var(--neutral-500);">Email:</span> <code id="geminiEmail" style="background: var(--neutral-100); padding: 2px 6px; border-radius: 4px;">-</code></div>
                      <div><span style="color: var(--neutral-500);">过期时间:</span> <span id="geminiExpiresAt" style="font-weight: 500;">-</span></div>
                    </div>
                  </div>

                  <div style="display: flex; gap: 8px;">
                    <button type="button" id="startGeminiOAuthBtn" class="btn btn-primary btn-sm" onclick="startGeminiOAuth()" style="padding: 8px 16px;">
                      🚀 开始 Google OAuth 授权
                    </button>
                    <button type="button" id="refreshGeminiTokenBtn" class="btn btn-secondary btn-sm" onclick="refreshGeminiToken()" style="padding: 8px 16px; display: none;">
                      🔄 刷新 Token
                    </button>
                    <button type="button" id="clearGeminiTokenBtn" class="btn btn-secondary btn-sm" onclick="clearGeminiToken()" style="padding: 8px 16px; display: none;">
                      🗑️ 清除授权
                    </button>
                  </div>

                  <div style="margin-top: 12px; font-size: 12px; color: var(--neutral-500);">
                    <p style="margin: 0;">点击授权后将跳转到 Google 登录页面，完成后请复制 URL 中的授权码并粘贴到下方。</p>
                  </div>

                  <!-- 手动输入授权码 -->
                  <div id="geminiManualCodeSection" style="margin-top: 12px;">
                    <div style="font-size: 12px; color: var(--neutral-500); margin-bottom: 8px;">
                      授权码（URL 中 <code style="background: var(--neutral-100); padding: 1px 4px; border-radius: 3px;">code=</code> 后的值）
                    </div>
                    <div style="display: flex; gap: 8px;">
                      <input type="text" id="geminiManualCodeInput" class="form-input" placeholder="粘贴 code=... 后的值" style="flex: 1; font-size: 12px;">
                      <button type="button" class="btn btn-secondary btn-sm" onclick="submitManualGeminiCode()" style="padding: 6px 12px; font-size: 12px;">
                        提交
                      </button>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
        <div class="form-group">
          <!-- 标签行：包含标签和操作按钮 -->
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
            <label class="form-label" style="margin: 0;">
              支持的模型 * <span class="models-hint" style="margin-left: 8px; margin-top: 0;">多个模型用英文逗号分隔</span>
            </label>
            <div style="display: flex; gap: 6px;">
              <button type="button" class="btn btn-secondary btn-sm" onclick="fetchModelsFromAPI()" style="padding: 5px 10px; font-size: 12px; display: inline-flex; align-items: center; gap: 4px;" title="从渠道API获取可用模型列表">
                <svg width="12" height="12" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg">
                  <path d="M13.65 2.35C12.2 0.9 10.21 0 8 0 3.58 0 0 3.58 0 8s3.58 8 8 8c3.73 0 6.84-2.55 7.73-6h-2.08c-.82 2.33-3.04 4-5.65 4-3.31 0-6-2.69-6-6s2.69-6 6-6c1.66 0 3.14.69 4.22 1.78L9 7h7V0l-2.35 2.35z" fill="currentColor"/>
                </svg>
                <span>获取模型列表</span>
              </button>
              <button type="button" class="btn btn-secondary btn-sm" onclick="clearAllModels()" style="padding: 5px 10px; font-size: 12px; display: inline-flex; align-items: center; gap: 4px;" title="清除所有模型">
                <svg width="12" height="12" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg">
                  <path d="M5.5 2.5V1.5C5.5 1.22386 5.72386 1 6 1H10C10.2761 1 10.5 1.22386 10.5 1.5V2.5M2 3.5H14M3 3.5V13.5C3 14.0523 3.44772 14.5 4 14.5H12C12.5523 14.5 13 14.0523 13 13.5V3.5" stroke="currentColor" stroke-width="1.2" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
                <span>清除所有</span>
              </button>
            </div>
          </div>
          <textarea id="channelModels" class="form-input" placeholder="claude-sonnet-4-5-20250929,claude-opus-4-5-20251205" required rows="2"></textarea>
        </div>
        <div class="form-group">
          <!-- 模型重定向标签行：包含标签和操作按钮 -->
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
            <label class="form-label" style="margin: 0;">
              模型重定向（可选） <span class="models-hint" style="margin-left: 8px; margin-top: 0;">将请求模型映射到实际转发模型，共 <span id="redirectCount">0</span> 条规则</span>
            </label>
            <div style="display: flex; gap: 6px;">
              <button type="button" class="btn btn-secondary btn-sm" onclick="addRedirectRow()" style="padding: 5px 10px; font-size: 12px; display: inline-flex; align-items: center; gap: 4px;" title="添加模型重定向规则">
                <svg width="12" height="12" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg">
                  <path d="M8 3.5V12.5M3.5 8H12.5" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
                <span>添加</span>
              </button>
            </div>
          </div>

          <!-- 重定向表格容器 -->
          <div style="max-height: 300px; overflow-y: auto; border: 1px solid var(--neutral-200); border-radius: 8px; background: var(--card-bg);">
            <table style="width: 100%; border-collapse: collapse;">
              <thead style="position: sticky; top: 0; z-index: 1; background: var(--neutral-100);">
                <tr style="border-bottom: 2px solid var(--neutral-300);">
                  <th style="padding: 8px 12px; text-align: left; font-weight: 600; font-size: 13px; width: 45%;">请求模型</th>
                  <th style="padding: 8px 12px; text-align: left; font-weight: 600; font-size: 13px; width: 45%;">实际模型</th>
                  <th style="padding: 8px 12px; text-align: center; font-weight: 600; font-size: 13px; width: 10%;">操作</th>
                </tr>
              </thead>
              <tbody id="redirectTableBody">
                <!-- 重定向行动态渲染 -->
              </tbody>
            </table>
          </div>
        </div>

        <!-- 用量监控配置（可选） -->
        <div class="form-group">
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
            <label class="form-label" style="margin: 0; display: flex; align-items: center; gap: 8px;">
              <span>用量监控（可选）</span>
              <label class="toggle-switch" style="margin: 0;">
                <input type="checkbox" id="quotaEnabled" onchange="toggleQuotaConfig()">
                <span class="toggle-slider"></span>
              </label>
            </label>
            <button type="button" id="quotaTestBtn" class="btn btn-secondary btn-sm" onclick="testQuotaFetch()" style="padding: 5px 10px; font-size: 12px; display: none;">
              测试获取
            </button>
          </div>

          <div id="quotaConfigPanel" style="display: none; padding: 12px; border: 1px solid var(--neutral-200); border-radius: 8px; background: var(--neutral-50);">
            <!-- 模板选择器 -->
            <div style="margin-bottom: 12px; padding-bottom: 12px; border-bottom: 1px dashed var(--neutral-200);">
              <label style="font-size: 12px; color: var(--neutral-600); margin-bottom: 4px; display: block;">快速填充模板</label>
              <div style="display: flex; gap: 8px; flex-wrap: wrap;">
                <button type="button" class="btn btn-secondary btn-sm" onclick="applyQuotaTemplate('newapi')" style="padding: 4px 10px; font-size: 12px;">
                  NEWAPI
                </button>
                <button type="button" class="btn btn-secondary btn-sm" onclick="applyQuotaTemplate('veloera')" style="padding: 4px 10px; font-size: 12px;">
                  Veloera
                </button>
                <button type="button" class="btn btn-secondary btn-sm" onclick="applyQuotaTemplate('oneapi')" style="padding: 4px 10px; font-size: 12px;">
                  OneAPI
                </button>
                <button type="button" id="codexQuotaTemplateBtn" class="btn btn-secondary btn-sm" onclick="applyQuotaTemplate('codex')" style="padding: 4px 10px; font-size: 12px; display: none;">
                  Codex 官方
                </button>
                <span id="quotaTemplateHint" style="font-size: 11px; color: var(--neutral-400); align-self: center; margin-left: 8px;">选择后请替换占位符</span>
              </div>
            </div>

            <div style="display: flex; gap: 12px; margin-bottom: 12px;">
              <div style="flex: 1;">
                <label style="font-size: 12px; color: var(--neutral-600); margin-bottom: 4px; display: block;">请求URL *</label>
                <input type="text" id="quotaUrl" class="form-input" placeholder="https://api.example.com/quota" style="font-size: 13px;">
              </div>
              <div style="width: 100px;">
                <label style="font-size: 12px; color: var(--neutral-600); margin-bottom: 4px; display: block;">方法</label>
                <select id="quotaMethod" class="form-input" style="font-size: 13px;">
                  <option value="GET">GET</option>
                  <option value="POST">POST</option>
                </select>
              </div>
              <div style="width: 120px;">
                <label style="font-size: 12px; color: var(--neutral-600); margin-bottom: 4px; display: block;">轮询间隔</label>
                <select id="quotaInterval" class="form-input" style="font-size: 13px;">
                  <option value="60">1分钟</option>
                  <option value="300" selected>5分钟</option>
                  <option value="600">10分钟</option>
                  <option value="1800">30分钟</option>
                </select>
              </div>
            </div>

            <div style="margin-bottom: 12px;">
              <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 4px;">
                <label style="font-size: 12px; color: var(--neutral-600);">请求头（可选）</label>
                <button type="button" class="btn btn-secondary btn-sm" onclick="addQuotaHeader()" style="padding: 2px 8px; font-size: 11px;">+ 添加</button>
              </div>
              <div id="quotaHeadersContainer" style="max-height: 100px; overflow-y: auto;"></div>
            </div>

            <div>
              <label style="font-size: 12px; color: var(--neutral-600); margin-bottom: 4px; display: block;">提取器脚本 * <span style="color: var(--warning-600); font-size: 11px;">(脚本在本地浏览器运行)</span></label>
              <textarea id="quotaExtractor" class="form-input" rows="6" placeholder="// 提取器函数，返回 {isValid, remaining, unit}
function(response) {
    const data = JSON.parse(response);
    return {
        isValid: true,
        remaining: data.credits,
        unit: 'USD'
    };
}" style="font-family: 'Monaco', 'Menlo', 'Consolas', monospace; font-size: 12px; line-height: 1.4;"></textarea>
            </div>
          </div>
        </div>

        <div class="form-group">
          <div style="display: flex; align-items: center; gap: 16px; flex-wrap: wrap;">
            <label class="form-label" style="margin: 0;">
              <input type="checkbox" id="channelEnabled" checked> 启用渠道
            </label>
            <div style="display: flex; align-items: center; gap: 8px;">
              <label class="form-label" for="channelPriority" style="margin: 0; white-space: nowrap;">优先级</label>
              <input type="number" id="channelPriority" class="form-input" value="0" min="-99999" max="99999" style="width: 100px; min-width: 100px;">
            </div>
            <div style="margin-left: auto; display: flex; gap: 12px;">
              <button type="button" class="btn btn-secondary" onclick="closeModal()">取消</button>
              <button type="submit" class="btn btn-primary">保存</button>
            </div>
          </div>
        </div>
      </form>
    </div>
  </div>

  <!-- 删除确认模态框 -->
  <div id="deleteModal" class="modal">
    <div class="modal-content confirm-modal">
      <h2 class="modal-title">确认删除</h2>
      <p>确定要删除渠道 "<span id="deleteChannelName"></span>" 吗？</p>
      <p style="color: var(--error-600); font-size: 0.875rem;">此操作不可恢复！</p>
      <div class="confirm-actions">
        <button class="btn btn-secondary" onclick="closeDeleteModal()">取消</button>
        <button class="btn btn-danger" onclick="confirmDelete()">删除</button>
      </div>
    </div>
  </div>

  <!-- 测试渠道模态框 -->
  <div id="testModal" class="modal">
    <div class="modal-content test-modal-content">
      <div class="modal-header">
        <h2 class="modal-title">测试渠道 - <span id="testChannelName"></span></h2>
        <button class="close-btn" onclick="closeTestModal()">&times;</button>
      </div>
      <div class="form-group">
        <label class="form-label" for="testChannelType">渠道类型</label>
        <select id="testChannelType" class="form-input" onchange="updateTestURL()">
          <!-- 动态加载渠道类型 -->
        </select>
      </div>

      <div class="form-group">
        <label class="form-label" for="testModelSelect">选择测试模型</label>
        <select id="testModelSelect" class="model-select">
          <!-- 动态填充模型选项 -->
        </select>
      </div>

      <div class="form-group" id="testKeySelectGroup" style="display: none;">
        <label class="form-label" for="testKeySelect">
          选择 API Key
          <span class="models-hint" style="margin-left: 8px;">单次测试时使用的 Key（最多显示前10个）</span>
        </label>
        <select id="testKeySelect" class="form-input">
          <!-- 动态填充 Key 选项（限制前10个） -->
        </select>
      </div>

      <div class="form-group">
        <label class="form-label" for="testContentInput">测试内容</label>
        <textarea id="testContentInput" class="form-input" rows="3" placeholder="输入测试内容..." style="resize: vertical; min-height: 80px;"></textarea>
        <div class="models-hint">默认内容从系统设置加载，可在"系统设置"页面修改</div>
      </div>

      <div class="form-group" id="streamGroup">
        <label class="form-label" style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
          <input type="checkbox" id="testStreamEnabled" checked style="width: 18px; height: 18px; cursor: pointer; accent-color: var(--primary-500);">
          <span>启用流式请求（Stream）</span>
        </label>
        <div id="streamHint" class="models-hint">默认开启流式测试</div>
      </div>

      <div class="form-group">
        <label class="form-label" for="testConcurrency">
          批量测试并发数
          <span class="models-hint" style="margin-left: 8px;">同时测试的Key数量（建议5-20）。冷却策略由服务器端自动应用（指数退避：2min→4min→8min→30min）</span>
        </label>
        <input type="number" id="testConcurrency" class="form-input" value="10" min="1" max="50" style="width: 150px;">
      </div>
      
      <!-- 测试进度 -->
      <div id="testProgress" class="test-progress">
        <div class="test-spinner"></div>
        <span id="testProgressText">正在测试API连接...</span>
      </div>

      <!-- 批量测试进度 -->
      <div id="batchTestProgress" style="display: none; margin-top: 16px; padding: 16px; background: var(--neutral-50); border-radius: 8px; border: 1px solid var(--neutral-200);">
        <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
          <span style="font-weight: 600; color: var(--neutral-700);">批量测试进度</span>
          <span id="batchTestCounter" style="color: var(--neutral-600);">0 / 0</span>
        </div>
        <div style="width: 100%; height: 8px; background: var(--neutral-200); border-radius: 4px; overflow: hidden;">
          <div id="batchTestProgressBar" style="width: 0%; height: 100%; background: linear-gradient(90deg, var(--primary-500), var(--primary-600)); transition: width 0.3s;"></div>
        </div>
        <div id="batchTestStatus" style="margin-top: 8px; font-size: 13px; color: var(--neutral-600);"></div>
      </div>
      
      <!-- 测试结果 -->
      <div id="testResult" class="test-result">
        <div id="testResultContent"></div>
        <div id="testResultDetails" class="test-details"></div>
      </div>
      
      <div class="form-actions">
        <button type="button" class="btn btn-secondary" onclick="closeTestModal()">关闭</button>
        <button type="button" id="runTestBtn" class="btn btn-primary" onclick="runChannelTest()">单个测试</button>
        <button type="button" id="batchTestBtn" class="btn btn-primary" onclick="runBatchTest()" style="display: none;">批量测试所有Key</button>
      </div>
    </div>
  </div>

  <!-- Key导入模态框 -->
  <div id="keyImportModal" class="modal">
    <div class="modal-content" style="max-width: 600px;">
      <div class="modal-header">
        <h2 class="modal-title">批量导入 API Keys</h2>
        <button class="close-btn" onclick="closeKeyImportModal()" style="width: 28px; height: 28px; border-radius: 50%; border: none; background: var(--neutral-100); color: var(--neutral-600); cursor: pointer; transition: all 0.2s; display: inline-flex; align-items: center; justify-content: center; padding: 0;" onmouseover="this.style.background='var(--neutral-200)'" onmouseout="this.style.background='var(--neutral-100)'">
          <svg width="14" height="14" viewBox="0 0 14 14" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path d="M10.5 3.5L3.5 10.5M3.5 3.5L10.5 10.5" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
        </button>
      </div>
      <div style="padding: 20px;">
        <div class="form-group" style="margin-bottom: 12px;">
          <label class="form-label" style="margin-bottom: 8px;">粘贴API Keys <span style="color: var(--neutral-500); font-size: 13px; font-weight: normal;">(支持逗号或换行分隔)</span></label>
          <textarea
            id="keyImportTextarea"
            class="form-input"
            rows="10"
            placeholder="sk-ant-key1,sk-ant-key2&#10;sk-ant-key3&#10;sk-ant-key4"
            style="resize: vertical; min-height: 200px; font-family: 'Monaco', 'Menlo', 'Courier New', monospace; font-size: 13px;"
          ></textarea>
        </div>
        <div style="padding: 12px; background: var(--info-50); border: 1px solid var(--info-500); border-radius: 6px; color: var(--neutral-700); font-size: 13px; margin-bottom: 16px;">
          <div style="display: flex; align-items: flex-start; gap: 8px;">
            <svg width="16" height="16" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" style="flex-shrink: 0; margin-top: 2px;">
              <circle cx="8" cy="8" r="6.5" stroke="currentColor" stroke-width="1.5"/>
              <path d="M8 5V8.5M8 11H8.005" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/>
            </svg>
            <div>
              <strong>使用说明：</strong>
              <ul style="margin: 6px 0 0 0; padding-left: 16px; line-height: 1.6;">
                <li>支持逗号分隔：<code style="background: rgba(0,0,0,0.05); padding: 2px 4px; border-radius: 3px;">key1,key2,key3</code></li>
                <li>支持换行分隔：每行一个Key</li>
                <li>自动去除空格、空行和重复Key</li>
              </ul>
            </div>
          </div>
        </div>
        <div id="keyImportPreview" style="display: none; margin-bottom: 16px;">
          <div style="padding: 12px; background: var(--success-50); border: 1px solid var(--success-500); border-radius: 6px; color: var(--success-600);">
            <div style="display: flex; align-items: center; gap: 8px; font-weight: 600;">
              <svg width="16" height="16" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path d="M3 8L6.5 11.5L13 5" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"/>
              </svg>
              <span>解析成功：将导入 <span id="keyImportCount">0</span> 个Key</span>
            </div>
          </div>
        </div>
      </div>
      <div class="form-actions">
        <button type="button" class="btn btn-secondary" onclick="closeKeyImportModal()">取消</button>
        <button type="button" class="btn btn-primary" onclick="confirmInlineKeyImport()">确认导入</button>
      </div>
    </div>
  </div>


  <!-- HTML模板定义 (分离HTML与JS) -->
  <template id="tpl-key-row">
    <tr style="border-bottom: 1px solid var(--neutral-200); height: 42px;" data-key-index="{{index}}">
      <td style="padding: 6px 10px;">
        <div style="display: flex; align-items: center; gap: 8px;">
          <input
            type="checkbox"
            class="key-checkbox"
            data-index="{{index}}"
            style="width: 16px; height: 16px; cursor: pointer; accent-color: var(--primary-500);"
          >
          <span style="color: var(--neutral-600); font-weight: 500; font-size: 13px;">{{displayIndex}}</span>
        </div>
      </td>
      <td style="padding: 6px 10px;">
        <input
          type="{{inputType}}"
          value="{{key}}"
          class="inline-key-input"
          data-index="{{index}}"
          style="width: 100%; padding: 5px 8px; border: 1px solid var(--neutral-300); border-radius: 6px; font-family: 'Monaco', 'Menlo', 'Courier New', monospace; font-size: 13px; transition: all 0.2s;"
        >
      </td>
      <td style="padding: 6px 10px;" class="key-cooldown-status">{{{cooldownHtml}}}</td>
      <td style="padding: 6px 10px; text-align: center;">{{{actionsHtml}}}</td>
    </tr>
  </template>

  <template id="tpl-key-empty">
    <tr>
      <td colspan="4" style="padding: 30px; text-align: center; color: var(--neutral-500); font-size: 14px;">
        {{message}}
      </td>
    </tr>
  </template>

  <!-- 内联端点行模板 -->
  <template id="tpl-inline-endpoint-row">
    <tr data-endpoint-index="{{index}}">
      <td style="padding: 6px 10px; width: 40px;">
        <span style="color: var(--neutral-600); font-weight: 500; font-size: 13px;">{{displayIndex}}</span>
      </td>
      <td style="padding: 6px 10px;">
        <input
          type="url"
          value="{{url}}"
          class="inline-endpoint-input"
          data-index="{{index}}"
          placeholder="https://api.anthropic.com"
          style="width: 100%; padding: 5px 8px; border: 1px solid var(--neutral-300); border-radius: 6px; font-family: 'Monaco', 'Menlo', 'Courier New', monospace; font-size: 13px; transition: all 0.2s; background: var(--input-bg); color: var(--text-main, var(--neutral-800));"
        >
      </td>
      <td style="padding: 6px 10px; width: 50px; text-align: center;">
        <button type="button" class="inline-endpoint-delete-btn" data-index="{{index}}" title="删除" style="width: 24px; height: 24px; border: none; background: transparent; color: var(--error-500); font-size: 16px; cursor: pointer; border-radius: 4px; display: {{deleteDisplay}};">×</button>
      </td>
    </tr>
  </template>

  <template id="tpl-cooldown-badge">
    <span style="color: var(--theme-badge-error-text); font-size: 11px; font-weight: 600; background: var(--theme-badge-error-bg-gradient); padding: 2px 6px; border-radius: 4px; border: 1px solid var(--theme-badge-error-border); white-space: nowrap; font-family: monospace;">⏱{{text}}</span>
  </template>

  <template id="tpl-key-normal-status">
    <span style="color: var(--success-600); font-size: 12px;">✓ 正常</span>
  </template>

  <template id="tpl-key-actions">
    <div style="display: flex; gap: 6px; justify-content: center;">
      <button
        type="button"
        class="key-action-btn"
        data-action="test"
        data-index="{{index}}"
        title="测试此Key"
        style="width: 28px; height: 28px; border-radius: 6px; border: 1px solid var(--neutral-200); background: var(--input-focus-bg); color: var(--neutral-500); cursor: pointer; transition: all 0.2s; display: inline-flex; align-items: center; justify-content: center; padding: 0;"
      >
        <svg width="12" height="12" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg">
          <path d="M4 2L12 8L4 14V2Z" fill="currentColor"/>
        </svg>
      </button>
      <button
        type="button"
        class="key-action-btn"
        data-action="delete"
        data-index="{{index}}"
        title="删除此Key"
        style="width: 28px; height: 28px; border-radius: 6px; border: 1px solid var(--neutral-200); background: var(--input-focus-bg); color: var(--neutral-500); cursor: pointer; transition: all 0.2s; display: inline-flex; align-items: center; justify-content: center; padding: 0;"
      >
        <svg width="12" height="12" viewBox="0 0 14 14" fill="none" xmlns="http://www.w3.org/2000/svg">
          <path d="M5.5 2.5V1.5C5.5 1.22386 5.72386 1 6 1H8C8.27614 1 8.5 1.22386 8.5 1.5V2.5M2 3.5H12M3 3.5V11.5C3 12.0523 3.44772 12.5 4 12.5H10C10.5523 12.5 11 12.0523 11 11.5V3.5M5.5 6.5V9.5M8.5 6.5V9.5" stroke="currentColor" stroke-width="1.2" stroke-linecap="round" stroke-linejoin="round"/>
        </svg>
      </button>
    </div>
  </template>

  <!-- 渠道卡片模板 -->
  <template id="tpl-channel-card">
    <div class="{{cardClasses}}" id="channel-{{id}}" data-channel-id="{{id}}">
      <div class="channel-row">
        <!-- 渠道名称（固定宽度，悬浮显示完整名称和模型） -->
        <div class="channel-col col-name" title="{{name}}&#10;模型: {{modelsText}}">
          <span class="channel-name-text">{{name}}</span>
          {{{typeBadge}}}
          <span class="channel-id">#{{id}}</span>
        </div>
        <!-- URL（固定宽度） -->
        <div class="channel-col col-url" title="{{url}}">
          <span class="channel-url-text">{{url}}</span>
        </div>
        <!-- 延迟（固定宽度） -->
        <div class="channel-col col-latency">
          <span class="latency-badge-container">{{{latencyBadge}}}</span>
        </div>
        <!-- 管理按钮（固定宽度） -->
        <div class="channel-col col-manage">
          <button type="button" class="endpoint-manage-btn" data-action="endpoints" data-channel-id="{{id}}" title="管理与测速">⚡管理</button>
        </div>
        <!-- 优先级（固定宽度） -->
        <div class="channel-col col-priority">
          <span class="col-label">优先级</span>
          <span class="col-value">{{priority}}</span>
        </div>
        <!-- 状态（固定宽度） -->
        <div class="channel-col col-status">
          <span class="col-value {{statusClass}}">{{statusText}}</span>
          <span class="cooldown-badge-container" data-channel-id="{{id}}">{{{cooldownBadge}}}</span>
        </div>
        <!-- 用量（固定宽度） -->
        <div class="channel-col col-quota">
          <span class="channel-quota-badge"></span>
        </div>
        <!-- 统计数据 -->
        <div class="channel-col col-stats">
          {{{statsHtml}}}
        </div>
        <!-- 操作按钮 -->
        <div class="channel-col col-actions">
          <!-- 编辑 -->
          <button class="btn-icon channel-action-btn" data-action="edit" data-channel-id="{{id}}" aria-label="编辑配置">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round">
              <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
              <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
            </svg>
          </button>
          <!-- 测试 -->
          <button class="btn-icon channel-action-btn" data-action="test" data-channel-id="{{id}}" data-channel-name="{{name}}" aria-label="测试连通性">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round">
              <polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"></polygon>
            </svg>
          </button>
          <!-- 禁用/启用 -->
          <button class="btn-icon channel-action-btn" data-action="toggle" data-channel-id="{{id}}" data-enabled="{{enabled}}" aria-label="{{toggleTitle}}">
            {{{toggleIcon}}}
          </button>
          <!-- 复制 -->
          <button class="btn-icon channel-action-btn" data-action="copy" data-channel-id="{{id}}" data-channel-name="{{name}}" aria-label="复制渠道">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round">
              <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
              <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
            </svg>
          </button>
          <!-- 删除 -->
          <button class="btn-icon btn-danger channel-action-btn" data-action="delete" data-channel-id="{{id}}" data-channel-name="{{name}}" aria-label="删除渠道">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round">
              <polyline points="3 6 5 6 21 6"></polyline>
              <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
            </svg>
          </button>
        </div>
      </div>
    </div>
  </template>

  <!-- 重定向规则行模板 -->
  <template id="tpl-redirect-row">
    <tr style="border-bottom: 1px solid var(--neutral-200);">
      <td style="padding: 8px 12px;">
        <input
          type="text"
          class="redirect-from-input"
          data-index="{{index}}"
          value="{{from}}"
          placeholder="claude-opus-4"
          style="width: 100%; padding: 6px 10px; border: 1px solid var(--neutral-300); border-radius: 6px; font-size: 13px; font-family: 'Monaco', 'Menlo', 'Courier New', monospace; background: var(--input-bg); color: var(--text-main);"
        >
      </td>
      <td style="padding: 8px 12px;">
        <input
          type="text"
          class="redirect-to-input"
          data-index="{{index}}"
          value="{{to}}"
          placeholder="claude-opus-4-20250514"
          style="width: 100%; padding: 6px 10px; border: 1px solid var(--neutral-300); border-radius: 6px; font-size: 13px; font-family: 'Monaco', 'Menlo', 'Courier New', monospace; background: var(--input-bg); color: var(--text-main);"
        >
      </td>
      <td style="padding: 8px 12px; text-align: center;">
        <button
          type="button"
          class="redirect-delete-btn"
          data-index="{{index}}"
          style="padding: 4px 8px; border-radius: 6px; border: 1px solid var(--error-300); background: var(--input-focus-bg); color: var(--error-600); cursor: pointer; font-size: 12px; transition: all 0.2s;"
          title="删除此规则"
        >
          删除
        </button>
      </td>
    </tr>
  </template>

  <!-- 重定向规则空状态模板 -->
  <template id="tpl-redirect-empty">
    <tr>
      <td colspan="3" style="padding: 20px; text-align: center; color: var(--neutral-500);">
        {{message}}
      </td>
    </tr>
  </template>

  <!-- 测试结果头部模板 -->
  <template id="tpl-test-result-header">
    <div style="display: flex; align-items: center; gap: 8px;">
      <span style="font-size: 18px;">{{icon}}</span>
      <strong>{{message}}</strong>
    </div>
  </template>

  <!-- 响应区块模板 -->
  <template id="tpl-response-section">
    <div class="response-section">
      <h4>{{title}}</h4>
      {{{toggleBtn}}}
      <div id="{{contentId}}" class="response-content" style="display: {{display}};">{{{content}}}</div>
    </div>
  </template>

  <!-- 批量测试失败详情模板 -->
  <template id="tpl-batch-fail-item">
    <li style="margin: 4px 0;"><strong>Key #{{keyNum}}</strong> ({{keyMask}}): {{error}}</li>
  </template>

  <!-- 端点管理弹窗 -->
  <div id="endpointModal" class="modal">
    <div class="modal-content" style="max-width: 600px;">
      <div class="modal-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
        <div style="display: flex; align-items: center; gap: 12px;">
          <h3 style="margin: 0; font-size: 1.1rem;"><span id="endpointCount">0</span> 个端点</h3>
          <label style="display: flex; align-items: center; gap: 6px; font-size: 0.875rem; cursor: pointer;">
            <input type="checkbox" id="autoSelectEndpoint" style="width: 16px; height: 16px;">
            <span>自动选择</span>
          </label>
        </div>
        <button type="button" id="testEndpointsBtn" class="btn btn-primary btn-sm" style="min-width: 80px;">
          <span id="testEndpointsBtnText">测速</span>
        </button>
      </div>

      <!-- 添加端点输入 -->
      <div style="display: flex; gap: 8px; margin-bottom: 12px;">
        <input type="url" id="newEndpointUrl" class="form-input" placeholder="https://api.example.com" style="flex: 1;">
        <button type="button" id="addEndpointBtn" class="btn btn-secondary" style="padding: 8px 16px;">+</button>
      </div>

      <!-- 端点列表 -->
      <div id="endpointList" style="max-height: 300px; overflow-y: auto; border: 1px solid var(--neutral-200); border-radius: 8px;">
        <!-- 端点项将动态插入 -->
      </div>

      <!-- 底部按钮 -->
      <div style="display: flex; justify-content: flex-end; gap: 12px; margin-top: 16px;">
        <button type="button" id="closeEndpointModalBtn" class="btn btn-secondary">关闭</button>
        <button type="button" id="saveEndpointsBtn" class="btn btn-primary">保存</button>
      </div>
    </div>
  </div>

  <!-- 端点项模板 -->
  <template id="tpl-endpoint-item">
    <div class="endpoint-item {{activeClass}}" data-endpoint-id="{{id}}" data-endpoint-index="{{index}}">
      <span class="endpoint-indicator" title="{{indicatorTitle}}">●</span>
      <span class="endpoint-url" title="{{url}}">{{url}}</span>
      <span class="endpoint-latency {{latencyClass}}">{{{latencyText}}}</span>
      <button type="button" class="endpoint-delete-btn" data-index="{{index}}" title="删除">×</button>
    </div>
  </template>

  <script src="/web/assets/js/template-engine.js"></script>
  <script src="/web/assets/js/channels-state.js"></script>
  <script src="/web/assets/js/channels-render.js"></script>
  <script src="/web/assets/js/channels-filters.js"></script>
  <script src="/web/assets/js/channels-data.js"></script>
  <script src="/web/assets/js/channels-import-export.js"></script>
  <script src="/web/assets/js/channels-keys.js"></script>
  <script src="/web/assets/js/channels-inline-endpoints.js"></script>
  <script src="/web/assets/js/channels-modals.js"></script>
  <script src="/web/assets/js/channels-quota.js"></script>
  <script src="/web/assets/js/channels-endpoints.js"></script>
  <script src="/web/assets/js/channels-test.js"></script>
  <script src="/web/assets/js/ui.js"></script>
  <script src="/web/assets/js/channels-init.js"></script>
</body>
</html>
