# 上游 master 分支变更总结

> 分叉点: `8b1083a` (2025-12-14)
> 统计时间: 2025-12-29
> 上游提交数: 93 个

---

## 🔴 核心修复（强烈建议吸收）

| 提交 | 说明 | 影响 |
|------|------|------|
| `540ed63` | HTTP 444 状态码不触发冷却问题，增强未知 4xx 兜底策略 | 冷却逻辑 |
| `65f5a23` | 客户端取消导致冷却写入短路 - 使用 `context.WithoutCancel` | 冷却逻辑 |
| `3d71a46` | 区分 context 取消与超时，返回正确的 HTTP 状态码 | 错误处理 |
| `ac72e02` | 流式请求 WriteTimeout 自残和 400/404 错误分类问题 | 流式传输 |
| `3fb7e6b` | 流式传输中首字节超时状态码错误 | 流式传输 |
| `f823b39` | 保留 499 context canceled 场景下已消耗的 token 统计 | Token 统计 |
| `eec61fa` | 区分 1308 配额错误与其他 SSE 错误避免影响成功率统计 | 成功率统计 |
| `5b9fc1d` | 软错误检测 - 识别 200 状态码的伪装错误响应 | 错误检测 |
| `17f991a` | SSE error 智能分类与 context 取消检查 | SSE 处理 |
| `24e68c8` | SSE error 事件使用独立状态码 597 便于日志筛选 | 日志筛选 |
| `526d1c0` | 405 错误重分类为 ErrorLevelChannel，日志诊断增强 | 错误分类 |

---

## 🟠 安全/稳定性

| 提交 | 说明 | 影响 |
|------|------|------|
| `9a4b3ac` | 分页参数 limit 增加上限校验 (max 1000) 防止 DoS | API 安全 |
| `b5315d9` | ConfigService 添加并发安全保护和 GetSetting 懒加载 | 并发安全 |
| `52e7f95` | 修复多处代码质量问题 | 代码质量 |

---

## 🟡 重构/简化

| 提交 | 说明 | 代码变化 |
|------|------|----------|
| `bee301b` | 移除过度设计，简化架构 | **-1015 行** |
| `862db98` | 移除缓存指标系统 | **-396 行** |
| `f8dc7a2` | 统一重试决策模型，简化冷却管理接口 | **-73 行** |
| `34ec58c` | 重构错误分类器，统一状态码映射逻辑 | 重构 |
| `d5302d0` | 移除过度设计的 SQL 字段白名单验证 | 简化 |
| `62cc42e` | 代码重构，消除重复代码并统一接口 | 重构 |
| `0fdb551` | 全冷却兜底改为开关 | 配置化 |
| `d98a02b` | 清理死代码与兼容壳 | 清理 |

---

## 🟢 新功能

### 模型匹配
| 提交 | 说明 |
|------|------|
| `b13522a` | 模型匹配支持日期后缀回退（如 `claude-3-5-sonnet-20241022` → `claude-3-5-sonnet`） |
| `65ca680` | 模型匹配忽略日期后缀双向回退 |
| `74b4ea3` | 日期后缀回退默认启用 |
| `4da6e27` | 模型日期后缀回退需考虑渠道类型过滤 |

### 计费/统计
| 提交 | 说明 |
|------|------|
| `a800114` | 支持 5 分钟和 1 小时缓存独立计费 |
| `51e002a` | 添加智谱 GLM 系列模型定价 |
| `71d29aa` | 修正 Claude Sonnet 长上下文定价 |
| `c295caa` | 统计页面新增渠道成本和模型成本饼图 |
| `5007161` | 添加按渠道和模型分组的 RPM 统计 |

### 渠道管理
| 提交 | 说明 |
|------|------|
| `36d3102` | 添加渠道拖拽排序功能 |
| `76e700f` | 支持渠道 Keys 拖拽排序 |
| `018255b` | Keys 拖拽排序后显示未保存提示 |
| `baa833d` | 渠道编辑页添加常用模型按钮 |
| `59cab84` | 添加渠道健康状态缓存机制 |

### 冷却/健康度
| 提交 | 说明 |
|------|------|
| `caadf1e` | 新增冷却兜底阈值配置，优化全冷却场景处理 |
| `54989d2` | 健康度缓存代码重构与全冷却兜底机制 |
| `9e2a1ee` | 渠道列表按健康度有效优先级排序 |

### 设置/UI
| 提交 | 说明 |
|------|------|
| `f791fca` | 设置页按分组展示 |
| `faeee1c` | 启动 Banner 和彩色版本信息显示 |
| `0dfbaf6` | 静态资源版本号缓存控制机制 |

### 测试
| 提交 | 说明 |
|------|------|
| `5730154` | anthropic 测试生成 claude-cli user_id |
| `a97619d` | 对齐 anthropic 渠道测试为 claude-cli 请求格式 |

---

## 🔵 前端优化

| 提交 | 说明 |
|------|------|
| `656e8cf` | 修复日志页面令牌筛选条件在页面切换后失效 |
| `af79c43` | 修复日志页面测试模型下拉框显示 `[object Object]` |
| `dbc7d88` | 修复模型列表显示 `[object Object]` |
| `0b6d622` | 优化日志页面模型显示 |
| `3387ddf` | 修复日志页面重定向模型角标显示异常 |
| `a86285b` | 优化页面加载体验和筛选交互 |
| `6fa7753` | 统计页面渠道/模型点击跳转日志页，登录后跳转回原地址 |
| `67f9f1b` | 优化趋势图表显示与自适应 |
| `f5fc45d` | 统计页面图表图例显示占比，筛选后图表同步更新 |
| `a2e61c2` | 统计页面添加表格/图表切换功能 |
| `4fec154` | 修复统计页面切换后表格/图表同时显示的问题 |
| `dafe0db` | 修复 trend 页面渠道名筛选和渠道列表显示问题 |
| `05b370e` | 修复 channels 和 trend 页面筛选条件序列化不完整 |
| `5506b35` | 修复 channels 页面模型筛选条件切换后不恢复选中状态 |
| `74628b1` | 排序后模型筛选按渠道类型 |

---

## ⚙️ 基础设施

| 提交 | 说明 |
|------|------|
| `c09b0ec` | 支持 arm64 多平台镜像构建 |
| `3ca1d2e` | 使用 alpine:3.20 修复 QEMU 模拟兼容性问题 |
| `e5dea1a` | GitHub Actions 自动发布工作流 |
| `23fff02` | 增强 Release Notes - 按 Conventional Commits 自动分类 |
| `c75fbaa` | 添加 pre-commit hook 自动格式化 Go 代码 |
| `e8ebef8` | gofmt/goimports 格式化全部 Go 代码 |
| `9bd6299` | 补全 Dockerfile 和 Makefile 的版本信息注入 |
| `ebe1b73` | 修复 GitHub Actions 构建镜像缺失 commit 信息 |

---

## ⚠️ API 变更

| 提交 | 变更 | 影响 |
|------|------|------|
| `93a052c` | `/admin/errors` → `/admin/logs` | 日志 API 路由重命名 |
| `af58944` | 统一 API 响应格式为 `{success, data, error, count}` | 响应格式 |

---

## 📊 统计排除

| 提交 | 说明 |
|------|------|
| `bde2316` | 趋势图数据排除 HTTP 499 状态码 |
| `5e496b2` | 统计指标排除 HTTP 499 状态码 |
| `33f43e9` | 过滤无实际请求的客户端取消日志噪音 |

---

## 🗑️ 移除的功能

| 提交 | 说明 |
|------|------|
| `15903bd` | 移除所有页面的 QPS 指标显示（只保留 RPM） |
| `58dfc75` | 移除 channel_models redirect_model 索引 |
| `a0e54fc` | 移除 logs 重复索引 |

---

## 📋 建议吸收优先级

### 第一优先级（核心 Bug 修复）
1. `65f5a23` - 客户端取消导致冷却短路
2. `3d71a46` - 区分 context 取消与超时
3. `ac72e02` - 流式请求 WriteTimeout 问题
4. `5b9fc1d` - 软错误检测（200 状态码伪装错误）
5. `eec61fa` - 1308 配额错误分类
6. `540ed63` - HTTP 444 冷却问题

### 第二优先级（稳定性/安全）
1. `9a4b3ac` - 分页参数上限校验
2. `b5315d9` - ConfigService 并发安全

### 第三优先级（有用的新功能）
1. `b13522a` 系列 - 模型日期后缀回退
2. `a800114` - 5 分钟/1 小时缓存独立计费

---

## ⚠️ 合并注意事项

1. **API 路由变更**: `/admin/errors` → `/admin/logs`，需要同步修改前端
2. **大量重构**: 上游做了大量简化重构（-1500+ 行），直接 merge 可能冲突很多
3. **功能重复**: 渠道拖拽排序你已经实现，上游也有类似功能，需要对比选择
4. **建议策略**: cherry-pick 核心修复，而非直接 merge 整个分支
